##### 0806

创建模型功能完整表映射。

sqlalchemy 每张表必须定义主键， 否则无法映射。

```
Mapper Mapper|User_Model_Type|user_model_type could not assemble any primary key columns for mapped table 'user_model_type' # 此错误极有可能就是没有主键引起的
```

string 类型必须设置长度。

外键设置出错， 无法创建外键表：Cannot add foreign key constraint。

``` python
# 从sqlalchemy 中导入ForeignKey
# 从sqlalchemy 中导入relationship
# 在每张表后面增加一个字段使用relationship

name = relationship('建立的类名')

# 在关联表中 使用ForeignKey

name = Column(Integer, ForeignKey('数据库表名.关联字段名称'))
# 无法迁移。
```

手动创建外键， 在数据库中增加。

编写数据获取流程，返回初始查询数据。

添加路径测试， 出现无法加载情况。jupyterlab 页面停留在启动页面， 无法加载内容。



##### 0807

下载notebook 源码， 对比操作。

删除生成的静态文件， schemas, staging  中的no_model以及build文件，static目录。 在此执行启动， 生成文件，就可以进入了。

修改代码错误， 测试数据。调整数据返回结构。



```
# 添加子类进入父类。
	...: for child_type in child_list:
    ...:     child_dict = []
    ...:     
    ...:     if f_type.TID == child_type.Father_ID:
    ...:         child_dict.append({'child_id': child_type.TID, 'child_name': child_type.Type_name})
    ...:         t_dict[child_type.Father_ID]['child'].append(child_dict)
    ...: print(child_dict)
    ...: print(t_dict)

```

##### 0808

添加完成model 类型接口。 返回数据。

完成gitlab 使用文档。详情见--》 gitlab.md



##### 0809

测试模型添加接口， 未完成。

gitlab 功能大概实例， 文档扩展。

gitlab 数据定时备份。

```
gitlab-rake gitlab:backup:create
使用以上命令会在/var/opt/gitlab/backups目录下创建一个名称类似为1393513186_gitlab_backup.tar的压缩包, 这个压缩包就是Gitlab整个的完整部分, 其中开头的1393513186是备份创建的日期.

Gitlab 修改备份文件默认目录
你也可以通过修改/etc/gitlab/gitlab.rb来修改默认存放备份文件的目录:

gitlab_rails['backup_path'] = '/mnt/backups'
/mnt/backups修改为你想存放备份的目录即可, 修改完成之后使用gitlab-ctl reconfigure命令重载配置文件即可.

Gitlab 自动备份
也可以通过crontab使用备份命令实现自动备份:

sudo su -
crontab -e
加入以下, 实现每天凌晨2点进行一次自动备份:

0 2 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create
Gitlab 恢复
同样, Gitlab的从备份恢复也非常简单:

# 停止相关数据连接服务
gitlab-ctl stop unicorn
gitlab-ctl stop sidekiq

# 从1393513186编号备份中恢复
gitlab-rake gitlab:backup:restore BACKUP=1393513186

# 启动Gitlab
sudo gitlab-ctl start
```

https://www.zhihu.com/question/19634226

http://wiki.mbalib.com/wiki/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90

https://www.jianshu.com/p/48178ce12934

https://blog.csdn.net/qq_41787597/article/details/79448117

https://www.zhihu.com/question/19735039

简单描述指标库功能



##### 0810

服务器全面崩溃， redmine, gitlab， 宿主机， vnc全部链接不上。

重启连接时出现以下内容：

```
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:lIxdb4NQ2AdA2TyEYkNLssaU2cx+kjVrSvVCCU0/ZDM.
Please contact your system administrator.
Add correct host key in /home/sunxr/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /home/sunxr/.ssh/known_hosts:3
  remove with:
  ssh-keygen -f "/home/sunxr/.ssh/known_hosts" -R "192.168.3.172"
ECDSA host key for 192.168.3.172 has changed and you have requested strict checking.
Host key verification failed.
```

按照以上操作`ssh-keygen -f "/home/sunxr/.ssh/known_hosts" -R "192.168.3.172"`

出现以下内容：

```
# Host 192.168.3.172 found: line 3
/home/sunxr/.ssh/known_hosts updated.
Original contents retained as /home/sunxr/.ssh/known_hosts.old
# 更新连接key
```

再次连接即可，不过ssh目录下的私钥和公钥就没了。

###### 配置gitlab 邮箱

gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.yhist.com"
gitlab_rails['smtp_port'] = 587
gitlab_rails['smtp_user_name'] = "redmine@yuist.com"
gitlab_rails['smtp_password'] = "YUhan!@#"
gitlab_rails['smtp_domain'] = "smtp.yhist.com"
gitlab_rails['smtp_authentication'] = "login"

https://www.zhihu.com/question/20640649



复制配置文件etc中：

sudo cp /usr/share/redmine/config/configuration.yml.example /etc/redmine/default/configuration.yml

编辑配置文件：sudo vim /etc/redmine/default/configuration.yml 

```
default:
  # Outgoing emails configuration
  # See the examples below and the Rails guide for more configuration options:
  # http://guides.rubyonrails.org/action_mailer_basics.html#action-mailer-configuration
  email_delivery:
    delivery_method: :async_smtp
    smtp_settings:
      address: "smtp.yhist.com"
      port: 587
      domain: "smtp.yhist.com"
      authentication: :login
      user_name: redmine@yhist.com
      password: "YUhan!@#"
```

重启apache2， redmine使用运行apache2上面， 重启apache2就是重启redmine。

重启postfix 邮件服务。 `sudo service postfix restart`

登录redmine， 进入配置文件， 配置邮箱设置保存。



##### 0811

http://victor87.coding.me/2016/01/22/redmine%E4%B8%8EGitlab%E9%9B%86%E6%88%90/ # 项目配置issues同步在redmine 上的配置， 在项目设置中导入所有仓库，最下面有redmine 配置选择。

DztNnUFpUW5xInJdd8xf # 版本服务key

版本库功能栏出现， 但是问发加载， 出现内部故障。



安装gitlab 认证插件: pip install oauthenticator

创建gitlab 添加应用程序。个人资料 》 应用程序 》 添加：

需要确保回调URL 为jupyterhub 运行服务器的URL `http://hub运行ip：port/hub/oauth_callback` ##### 此处网上多为gitlab.com/users/oauth/gitlab/callback

测试中出现重定向url 无效。

配置jupyterhub 运行文件： 以下全部为增加内容。

```python
from oauthenticator.gitlab import GitLabOAuthenticator
c.JupyterHub.authenticator_class = GitLabOAuthenticator

c.GitLabOAuthenticator.oauth_callback_url = 'http://192.168.3.181:8000/hub/o    auth_callback'
c.GitLabOAuthenticator.client_id = '2ea2a4dd93c95665138f9e85d18d70719b7285c2    ffd092079c0a8967ec307eaa'
c.GitLabOAuthenticator.client_secret = '7d276e5681929c02dedbcfdcbe74fc1d1789    f0a6dc194ce40efa1f788394517c'
```

配置gitlab 认证默认跳转网址： 

/home/sunxr/.pyenv/versions/jupyterhub_env/lib/python3.6/site-packages/oauthenticator

修改gitlab 认证跳转路径， GITLAB_HOST = os.environ.get(‘GITLAB_HOST’) or ‘[https://gitlab.com](https://gitlab.com/)’   将网址替换为服务器地址。

运行即可。

出现退出之后在再次登录，不会定向为gitlab 登录页面，一直是上一次登录页面，不太清楚什么原因， 有的时候可以重定向至登录页面。

https://blog.csdn.net/qq_16094777/article/details/78771716 # 参考网站



##### 0813

拉取nbviewer docker 镜像， 测试nbviewer。、

目前不知道使用gitlab路由， 测试。

源代码运行， 创建运行环境， 无法成功运行， 安装包有个装不上。

更换python版本在此安装， 升级pip， 安装依赖包，还是不行。

https://github.com/GoogleCloudPlatform/google-cloud-python/issues/3884

https://github.com/facebook/prophet/issues/418 #参考网站。

```
# 升级pip 
# 升级setuptools
# 使用easy_install 
```



##### 0814

线上安装分析环境， 服务器安装配置。



gitlab 数据备份加载：

```
# 数据文件需要在 /var/opt/gitlab/backips 下
# 停止数据操作
sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop sidekiq

# 恢复数据， 最后为文件的时间戳
# This command will overwrite the contents of your GitLab database!
sudo gitlab-rake gitlab:backup:restore BACKUP=1393513186
# 启动
# Start GitLab
sudo gitlab-ctl start
# 创建卫星
# Create satellites
sudo gitlab-rake gitlab:satellites:create
# 
# Check GitLab
sudo gitlab-rake gitlab:check SANITIZE=true
```

未成功， 出现权限不足， 以后不应该在root下面安装， 需要使用用户权限安装.

#### gitlab 安装错误： 重启配置出现红字， 

export LC_CTYPE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
sudo dpkg-reconfigure locales

#### 重新设置以上

docker jupyterhub 配置使用gitlab 认证：

```
from oauthenticator.gitlab import GitLabOAuthenticator
c.JupyterHub.authenticator_class = GitLabOAuthenticator

c.GitLabOAuthenticator.oauth_callback_url = 'http://106.14.127.47/hub/oauth_callback'
c.GitLabOAuthenticator.client_id = '71ccec01abc29b7288ed7543bb85f014a165d384333f2c31a85c15934c77dfa2'
c.GitLabOAuthenticator.client_secret = '27876bf5ffe9be1c46fd638976afba61de96acb8a123441c58d9ed5fc1a6963a'
c.JupyterHub.hub_ip = '172.17.0.1'
c.JupyterHub.hub_port = 8081
c.JupyterHub.ip = '127.0.0.1'
c.JupyterHub.port = 8000
c.JupyterHub.spawner_class = 'dockerspawner.DockerSpawner'
c.DockerSpawner.image = 'jupyterhub/singleuser:latest'
c.DockerSpawner.remove = True
c.DockerSpawner.remove_containers = True
c.PAMAuthenticator.open_sessions = True
c.Spawner.default_url = '/lab'
c.Spawner.cmd = [
                # 'jupyterhub-singleuser'
                'jupyter-labhub'
                ]
```

注意一点： sudo ufw allow in on docker0 to any port 8081 开启docker默认网关的8081端口



sk@192.168.3.239  密码sgds

公网redmine ip: 47.100.211.52 : sgds123!@#



##### 0815

在本地服务安装docker， 修改原来的连接配置， 增加docker配置。

```
# ubuntu docker 组配置
# 添加用户docker操作权限

```

后台运行使用nohup ,命令格式注意后面的一个 & 符号。 

nohup jupyter notebook  &.

docker 镜像产卵数据卷存储不下来。

**ubuntu 删除apt-get安装的软件，并删除配置文件**

apt-get remove --purge [name]

##### 0816

nbviewer 运行包中pycurl 无法安装， 

当安装`pycurl`通过`pip`一些错误可以在编译过程中发生。最可能的原因是缺少构建程序包所需的依赖项。好消息是，可以通过安装缺少的库并重试安装来轻松解决这个问题 

在Ubuntu内安装`sudo apt-get install libssl-dev libcurl4-openssl-dev python-dev`。然后重新运行该`pip install pycurl`命令以安装包而不会出错。 

再次安装：出现`error: command 'gcc' failed with exit status 1`报错。

安装依赖包： sudo apt-get install libmemcached-dev

再次运行安装： pip install pylibmc 。

运行时出现：网页没有布局， 运行pip install -r requirements-dev.txt，

再次启动即可。

**pyenv 加载本地（pyenv全局）环境， 不加载独立环境**



##### 0817

开启ubuntu root 远程登录权限：

```
可以对 openssh server进行配置

$ sudo vi /etc/ssh/sshd_config

找到PermitRootLogin no一行，改为PermitRootLogin yes
```

pyenv 环境加载问题， 加载不是项目环境中的包， 而是本地的， 环境隔离出现冲突。

网上收不到， 最后扩展虚拟机空间，就可以了。



##### 0819

https://github.com/bokeh/jupyterlab_bokeh #lab bokeh 扩展

https://github.com/sat28/githubcommit #lab git扩展

https://github.com/m-rossi/jupyter_docx_bundler # 导出扩展 docx

https://github.com/fcollonval/jupyterlab_api_ext # lab增加tab栏试例

https://github.com/mishra14/jupyterliveshare # 实时分享

https://github.com/acrule/comet_server

https://github.com/TheGrum/python3-physics/blob/master/physics.py

https://www.cnblogs.com/kongqi816-boke/p/5883970.html # tornado 项目练习



##### 0820

nbviewer 隐藏代码， 测试。

在notebook.html 文件中添加一下内容

```js
<script>
    function code_toggle() {
        if (code_shown) {
            $('div.input').hide('500');
            $('#togglButton').val('Show Code');
        } else {
            $('div.input').show('500');
            $("#toggleButton").val('Hide Code')
        }
        code_shown = !code_shown
    }

    $(document).ready(function () {
        code_shown = false;
        $('div.input').hide()
    });
</script>
<form action="javascript:code_toggle()">
    <input type="submit" id="toggleButton" value="Show Code">
</form>
```

按钮出现在页面最底部， 默认样式， 没有设计样式， 

查找在头部显示的方式，在layout(布局页面找到了， 但是添加之后无法显示，依靠 模板的 宏函数创建的， 还没有成)

```
# layout.html
使用宏（head_text）创建图标， 可以， 位置也可以， 不过点击事件不好处理，
# notebook.html
同样使用宏添加图标， 在block otherlinks, 中添加。样式不好定义， 点击事件也不行。

```



##### 0821

显示位置固定， 样式很丑， 现在已按钮形式显示

启动localfile 加载本地notebook 文件， 启动时使用--localfile参数指定启示目录， 在浏览器中手动输入路由或完整路径， 

```
案例： http://192.168.3.181:8000/localfile/sunxr/git_data/nbview/demo_04.ipynb 
```

由handlers创建路由， 进而重定向至所创建的路由处理。通过tornado 的Asynchttpclient 获取，进而处理其中的json文件。

AsyncHTTPClient()配置主题在app文件中， 在providers中url的client文件中增加了其他的处理函数。并通过多继承配置给AsyncHTTPClient().



##### 0822

创建gitlab包， 复制github中 client，handlers文件， 修改其中变量名称。 将其更换为gitlab 服务器地址。测试无效， 没有找到路由， 没有在gitlab包 init 文件中引入路由设置， 没有在providers 中添加gitlab 包名。

https://zhuanlan.zhihu.com/p/34931359 # gitlab 在线查看代码工具，

ubuntu shadowsocks 启动命令

sslocal -c /etc/shadowsocks/config.json

创建访问令牌， 个人设置，访问令牌，生成令牌， 不可更改。生成之后即可使用， 目前不知道怎么再次查看密码 *1QhNPwBBq-p9CyytaHY6*

gitlab API 使用案列

https://docs.gitlab.com/ce/api/repository_files.html#get-file-from-repository # 获取文件信息

https://docs.gitlab.com/ce/api/repositories.html#get-a-blob-from-repository # 获取文件blob信息， 原始数据

```
# 此接口获取到 项目ID 为21 的文件列表
curl -o 234.html --header 'PRIVATE_TOKEN: 1QhNPwBBq-p9CyytaHY6' 'http://192.168.3.43/api/v4/projects/21/repository/tree'
```

**api/v4/projects** 获取公开的项目信息。 

```
# 获取项目ID 24 的目录结构。
curl -o tree.html --header 'PRIVATE_TOKEN: 1QhNPwBBq-p9CyytaHY6' 'http://192.168.3.43/api/v4/projects/24/repository/tree'
# id（必需） - 经过身份验证的用户拥有的项目的ID或URL编码路径
# path（可选） - 存储库内的路径。用于争夺子目录 使用该参数之后该参数下的目录列表和存储库信息。
# ref （可选） - 存储库分支或标记的名称，如果没有给出默认分支
# recursive （可选） - 用于获取递归树的布尔值（默认为false）
```

获取文件。

```
# 获取项目文件， 注意点： 项目ID， 必填。 文件名称。相对与项目的相对路径（项目ID，经即项目根路径）。文件名称中的点以及斜杠使用特殊符号代替。 斜杠使用（%2F），点（%2E）
curl -o ipynb.html --header 'PRIVATE_TOKEN: 1QhNPwBBq-p9CyytaHY6' 'http://192.168.3.43/api/v4/projects/21/repository/files/demo_04%2Eipynb?ref=master'
```

```
# 获取原始文件，在原路径后面增加一个/raw
curl -o ipynb-raw.html --header 'PRIVATE_TOKEN: 1QhNPwBBq-p9CyytaHY6' 'http://192.168.3.43/api/v4/projects/21/repository/files/demo_04%2Eipynb/raw?ref=master'
```

获取blod内容, 路由后边多了一个/raw。 即为获取文件原始信息， 目前即为json数据获取到。

```
# 获取文件中的原始blob内容，即文件原始内容，不再是gitlab 存储库的blob内容。得到想要的了
# 但是目前只是支持公开访问的。
curl -o demo_04.ipynb --header 'PRIVATE_TOKEN: 1QhNPwBBq-p9CyytaHY6' 'http://192.168.3.43/api/v4/projects/21/repository/blobs/a553401aebf4554bc21bd583fed0265e8d8ce171/raw?ref=master'
```

总结：

1， 获取项目或储存库信息， 查看全部的公开的项目信息。

```
'http://192.168.3.43/api/v4/projects'
```

2， 获取项目具体信息， 主要为目录结构信息。

```
'http://192.168.3.43/api/v4/projects/24/repository/tree'
```

3， 获取项目文件信息和原始信息。不是文件的原始信息，而是文件的大小，等描述问题。

```
# 详细信息看上边
'http://192.168.3.43/api/v4/projects/21/repository/files/demo_04%2Eipynb?ref=master'
'http://192.168.3.43/api/v4/projects/21/repository/files/demo_04%2Eipynb/raw?ref=master'
```

4， 获取项目文件 blob 信息和原始内容， 文件内部原始信息。

```
'http://192.168.3.43/api/v4/projects/21/repository/blobs/a553401aebf4554bc21bd583fed0265e8d8ce171/raw?ref=master'
```

##### 0823

https://docs.gitlab.com/ce/api/README.html#status-codes # gitlab 文档

vm虚拟机硬盘扩展之后需要重新挂载。

```
sudo fdisk -l
# 查看分区信息， 找到未挂载的分区。
sudo fdisk /dev/需要挂载的硬盘。（sda1）
创建分区信息。
进入选项，n, 创建分区， e， 传概念扩展分区。 p，创建主分区。
之后可直接回车，选择默认选项。
最后w 保存退出。

为分区格式化为ext3格式。 创建文件系统。
mkfs -t ext3 /dev/sda
创建挂载目录
sudo mkdir /dev/extension
挂载硬盘
sudo mount	/dev/sda2 /dev/extension
设置启动加载， 修改/etc/fstab文件
/dev/sda2	/dev/extension	ext4	default		12
```

线上配属nbviewer 上次出现的又出现了， 不过好解决，

这次出现了另一个问题： 同样是页面没有样式， 

```
subprocess.CalledProcessError: Command '['invoke', 'less']' returned non-zero exit status 1.
```

线上使用anaconda环境： 安装invoke

```
conda install -c conda-forge invoke
```

安裝less：

```
conda install -c conda-forge lesspy
```





